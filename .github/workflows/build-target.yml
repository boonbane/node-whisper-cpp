name: build-target

on:
  workflow_call:
    inputs:
      triple:
        required: true
        type: string
      os:
        required: true
        type: string
      backend:
        required: true
        type: string
      cuda:
        required: false
        type: string
        default: ""
      smoke:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  build:
    runs-on: ${{ inputs.os }}
    env:
      SCCACHE_DIR: ${{ github.workspace }}/.cache/sccache
      SCCACHE_CACHE_SIZE: 4G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: bun run ./tools/ci.ts install

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja
          bun install

      - name: Resolve CUDA paths
        if: inputs.cuda != ''
        id: cuda-paths
        run: bun run ./tools/cuda.ts paths ${{ inputs.cuda }}

      - name: Cache CUDA toolkit
        if: inputs.cuda != ''
        uses: actions/cache@v4
        with:
          path: ${{ steps.cuda-paths.outputs.path }}
          key: cuda-toolkit-${{ inputs.cuda }}-${{ runner.os }}-${{ runner.arch }}

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: sccache-${{ inputs.triple }}-${{ github.run_id }}
          restore-keys: |
            sccache-${{ inputs.triple }}-

      - name: Setup CUDA
        if: inputs.cuda != ''
        run: bun run ./tools/cuda.ts install ${{ inputs.cuda }}

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Build native addon
        run: bun run ./tools/build.ts addon --backend ${{ inputs.backend }} --ci

      - name: Build JS package for smoke test
        run: bun run ./tools/build.ts js

      - name: Smoke test
        if: inputs.smoke
        run: bun run test

      - name: Stage artifacts
        run: bun run ./tools/stage.ts addon

      - name: Normalize CUDA cache permissions
        if: inputs.cuda != '' && always()
        run: bun run ./tools/cuda.ts normalize-cache-permissions ${{ inputs.cuda }}

      - name: Show sccache stats
        if: always()
        run: sccache --show-stats || true

      - name: Upload artifacts
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          include-hidden-files: true
          name: ${{ inputs.triple }}
          path: artifacts
